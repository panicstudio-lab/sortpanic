<!DOCTYPE html>
<html lang="en">
<head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LQ5NKJP9DS"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-LQ5NKJP9DS');
</script>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#F5E6FF">
<meta name="description" content="Sort Panic - Don't Think. Just Sort.">
<link rel="manifest" href="manifest.json">

<!-- Favicon -->
<link rel="icon" type="image/png" href="/icon-512.png">
<link rel="apple-touch-icon" href="/icon-512.png">

<title>Sort Panic - Play</title>

<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  user-select: none;
  -webkit-tap-highlight-color: transparent;
}

:root {
  --blue: #B8D4FF;
  --pink: #FFB8D1;
  --purple: #E6CCFF;
  --mint: #B8FFD9;
  --peach: #FFD4B8;
  --bg: linear-gradient(135deg, #F5E6FF, #E6F5FF);
  --dark: #4A4A5E;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  background: var(--bg);
  height: 100vh;
  overflow: hidden;
  position: relative;
}

/* Back to Home Link */
/* Animated background */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background: 
    radial-gradient(circle at 20% 50%, rgba(184, 212, 255, 0.15) 0%, transparent 50%),
    radial-gradient(circle at 80% 80%, rgba(255, 184, 209, 0.15) 0%, transparent 50%);
  animation: breathe 8s ease-in-out infinite;
  pointer-events: none;
}

@keyframes breathe {
  0%, 100% { opacity: 0.5; }
  50% { opacity: 0.8; }
}

/* ---------- SCREENS ---------- */
.screen {
  position: absolute;
  inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 18px;
  z-index: 10;
}

.hidden { display: none; }

/* ---------- LEVEL SELECT ---------- */
#levelSelect {
  padding: 20px;
  padding-top: 40px;
  overflow-y: auto;
  max-height: 100vh;
  justify-content: flex-start !important; /* Override .screen centering */
}

.level-tile {
  width: 100%;
  max-width: 320px;
  padding: 16px;
  margin-bottom: 8px;
  border-radius: 18px;
  background: white;
  box-shadow: 0 6px 20px rgba(0,0,0,.09);
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 17px;
  font-weight: 700;
  cursor: pointer;
  transition: transform .15s, opacity .15s;
  position: relative;
}

.level-tile::before {
  content: '';
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  width: 5px;
  border-radius: 18px 0 0 18px;
  transition: width 0.3s;
}

.level-tile:nth-child(1)::before { background: var(--blue); }
.level-tile:nth-child(2)::before { background: var(--pink); }
.level-tile:nth-child(3)::before { background: var(--purple); }
.level-tile:nth-child(4)::before { background: var(--mint); }
.level-tile:nth-child(5)::before { background: var(--peach); }

.level-tile:not(.locked):hover::before {
  width: 12px;
}

.level-tile span {
  font-size: 13px;
  opacity: .7;
}

.level-tile .best-score {
  font-size: 12px;
  color: #999;
  margin-top: 4px;
}

.level-tile .unlock-hint {
  font-size: 11px;
  color: #4CAF50;
  margin-top: 4px;
  font-weight: 600;
}

.level-tile .unlock-requirement {
  font-size: 12px;
  color: #999;
  margin-top: 4px;
}

.level-tile.locked {
  opacity: .35;
  cursor: default;
}

.level-tile:not(.locked):active {
  transform: scale(.97);
}

/* Challenge Tile Styling */
.challenge-tile {
  background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%) !important;
  border: 3px solid #FF6B6B;
  box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4) !important;
  animation: challengePulse 2s ease-in-out infinite;
  margin-bottom: 20px;
}

.challenge-tile::before {
  display: none; /* No color bar for challenge */
}

@keyframes challengePulse {
  0%, 100% { box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4); }
  50% { box-shadow: 0 8px 30px rgba(255, 107, 107, 0.6); }
}

.challenge-timer, .challenge-target {
  font-size: 12px;
  color: #666;
  margin-top: 4px;
  font-weight: 600;
}

/* ---------- GAME ---------- */
#game {
  position: absolute;
  inset: 0;
  z-index: 5;
}

#scoreDisplay {
  position: absolute;
  top: 24px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 52px;
  font-weight: 700;
  color: var(--dark);
  text-shadow: 0 2px 10px rgba(255,255,255,0.8);
  z-index: 20;
}

#area {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 200px;
}

.object {
  position: absolute;
  width: 80px;
  height: 80px;
  border-radius: 50%;
  left: 50%;
  transform: translateX(-50%);
  box-shadow: 0 10px 30px rgba(0,0,0,.15);
  transition: none;
}

/* Level 4: Precision - smaller objects */
.object.small {
  width: 50px;
  height: 50px;
}

.object.explode {
  animation: explode 0.3s ease-out forwards;
}

@keyframes explode {
  0% {
    transform: translateX(-50%) scale(1);
    opacity: 1;
  }
  100% {
    transform: translateX(-50%) scale(2);
    opacity: 0;
  }
}

/* Particle effect */
.particle {
  position: absolute;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  pointer-events: none;
  animation: particle-fly 0.6s ease-out forwards;
}

@keyframes particle-fly {
  0% {
    transform: translate(0, 0) scale(1);
    opacity: 1;
  }
  100% {
    transform: translate(var(--tx), var(--ty)) scale(0);
    opacity: 0;
  }
}

/* Screen shake */
@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-10px); }
  75% { transform: translateX(10px); }
}

.shake {
  animation: shake 0.3s;
}

/* ---------- CONTROLS ---------- */
#controls {
  position: absolute;
  bottom: 0;
  width: 100%;
  height: 200px;
  z-index: 15;
}

.zone {
  position: absolute;
  width: 50%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 40px;
  font-weight: 700;
  color: white;
  transition: transform .4s cubic-bezier(.34,1.56,.64,1);
  cursor: pointer;
}

#left {
  left: 0;
}

#right {
  right: 0;
}

.zone::before {
  content: '';
  position: absolute;
  inset: 0;
  opacity: 0.6;
  transition: opacity 0.2s;
}

#left::before {
  background: linear-gradient(to top, var(--blue), transparent);
}

#right::before {
  background: linear-gradient(to top, var(--pink), transparent);
}

/* When swapped, reverse the colors */
#left.swapped-zone::before {
  background: linear-gradient(to top, var(--pink), transparent);
}

#right.swapped-zone::before {
  background: linear-gradient(to top, var(--blue), transparent);
}

.zone:active::before {
  opacity: 0.9;
}

.zone span {
  position: relative;
  z-index: 1;
  text-shadow: 0 2px 10px rgba(0,0,0,0.2);
}

/* Level 4: Precision - smaller zones */
.zone.swapped-left {
  transform: translateX(100%);
}

.zone.swapped-right {
  transform: translateX(-100%);
}

.zone.narrow {
  width: 35%;
}

#left.narrow {
  left: 0;
}

#right.narrow {
  right: 0;
}

/* ---------- GAME OVER ---------- */
#gameOver {
  padding: 24px;
}

#gameOver h2 {
  font-size: 42px;
  margin-bottom: 10px;
}

#gameOver .final-score {
  font-size: 72px;
  font-weight: 700;
  color: var(--purple);
  margin-bottom: 8px;
}

#gameOver .stats {
  font-size: 16px;
  color: #666;
  margin-bottom: 24px;
}

#progressNotice {
  font-size: 16px;
  color: #999;
  margin-bottom: 20px;
  padding: 12px;
  background: rgba(0,0,0,0.05);
  border-radius: 12px;
}

/* ---------- LEVEL COMPLETE SCREEN ---------- */
#levelComplete {
  background: linear-gradient(135deg, var(--purple) 0%, var(--pink) 50%, var(--peach) 100%);
  padding: 20px;
}

.celebration-screen {
  max-width: 500px;
  margin: 0 auto;
  display: flex;
  flex-direction: column;
  gap: 15px;
}

#levelComplete h2 {
  font-size: 1.5rem;
  color: white;
  text-align: center;
  margin: 10px 0;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
}

.complete-card {
  background: white;
  border-radius: 20px;
  padding: 20px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.2);
}

.score-section {
  text-align: center;
  padding-bottom: 15px;
  border-bottom: 2px solid #f0f0f0;
  margin-bottom: 15px;
}

.score-value {
  font-size: 3.5rem;
  font-weight: 700;
  color: var(--purple);
  line-height: 1;
}

.target-met {
  font-size: 1rem;
  color: #4CAF50;
  font-weight: 600;
  margin-top: 5px;
}

.unlock-section {
  text-align: center;
}

.unlock-text {
  font-size: 1.1rem;
  font-weight: 700;
  color: var(--pink);
  margin-bottom: 10px;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.unlock-level-name {
  font-size: 1.4rem;
  font-weight: 700;
  color: var(--dark);
  margin-bottom: 5px;
}

.unlock-level-desc {
  font-size: 0.9rem;
  color: #666;
  font-style: italic;
}

/* ---------- HIGH SCORE SCREEN ---------- */
#highScore {
  padding: 20px;
  background: linear-gradient(135deg, var(--blue) 0%, var(--purple) 100%);
}

.highscore-screen {
  max-width: 500px;
  margin: 0 auto;
  display: flex;
  flex-direction: column;
  gap: 15px;
}

#highScore h2 {
  font-size: 1.5rem;
  color: white;
  text-align: center;
  margin: 10px 0;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
}

.highscore-card {
  background: white;
  border-radius: 20px;
  padding: 20px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.2);
  text-align: center;
}

.score-display {
  margin-bottom: 15px;
}

.new-score-value {
  font-size: 3.5rem;
  font-weight: 700;
  color: #FFD700;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
  line-height: 1;
}

.score-improvement {
  font-size: 0.9rem;
  color: #999;
  margin-top: 8px;
}

.previous-label {
  margin-right: 5px;
}

.stats-line {
  padding-top: 12px;
  border-top: 2px solid #f0f0f0;
  font-size: 0.9rem;
  color: #666;
  min-height: 20px;
}

/* ---------- BUTTON STYLES ---------- */
.button-row {
  display: flex;
  gap: 8px;
  justify-content: center;
  flex-wrap: wrap;
}

button.compact {
  font-size: 0.9rem;
  padding: 12px 20px;
  flex: 1;
  min-width: 90px;
  max-width: 150px;
}

button.primary.large {
  font-size: 1.2rem;
  padding: 16px 40px;
  width: 100%;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% {
    transform: scale(1);
    box-shadow: 0 6px 20px rgba(230, 204, 255, 0.3);
  }
  50% {
    transform: scale(1.02);
    box-shadow: 0 8px 30px rgba(230, 204, 255, 0.5);
  }
}

button {
  font-family: inherit;
  font-size: 20px;
  padding: 16px 44px;
  border-radius: 36px;
  border: none;
  background: linear-gradient(135deg, #E6CCFF, #FFB8D1);
  color: white;
  font-weight: 700;
  cursor: pointer;
  transition: transform 0.2s, box-shadow 0.2s;
  box-shadow: 0 6px 20px rgba(230, 204, 255, 0.3);
  margin: 6px;
}

button:active {
  transform: scale(0.95);
}

button.primary {
  background: linear-gradient(135deg, var(--pink), var(--purple));
}

button.secondary {
  background: white;
  color: var(--dark);
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

/* Share button special styling */
#shareBtn, #shareBtnComplete, #shareBtnHigh {
  background: linear-gradient(135deg, var(--mint), var(--blue));
  display: flex;
  align-items: center;
  gap: 8px;
  justify-content: center;
}

/* ---------- PERFECT BADGE ---------- */
.perfect-badge {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 72px;
  animation: perfectBadge 1.5s ease-out forwards;
  pointer-events: none;
  z-index: 100;
}

@keyframes perfectBadge {
  0% {
    transform: translate(-50%, -50%) scale(0) rotate(-180deg);
    opacity: 0;
  }
  50% {
    transform: translate(-50%, -50%) scale(1.2) rotate(10deg);
    opacity: 1;
  }
  100% {
    transform: translate(-50%, -50%) scale(1) rotate(0deg);
    opacity: 0;
  }
}

/* Title screen */
#titleScreen {
  padding: 40px;
  text-align: center;
}

#titleScreen h1 {
  font-size: 64px;
  margin-bottom: 12px;
  background: linear-gradient(135deg, var(--purple), var(--pink));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

#titleScreen .tagline {
  font-size: 20px;
  color: #666;
  margin-bottom: 50px;
}

/* Install prompt */
#installPrompt {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: white;
  padding: 16px 24px;
  border-radius: 20px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.15);
  display: none;
  align-items: center;
  gap: 12px;
  z-index: 1000;
  max-width: 90%;
}

#installPrompt.show {
  display: flex;
  animation: slideUp 0.4s ease-out;
}

@keyframes slideUp {
  from {
    transform: translate(-50%, 100px);
    opacity: 0;
  }
  to {
    transform: translate(-50%, 0);
    opacity: 1;
  }
}

#installPrompt button {
  padding: 10px 20px;
  font-size: 16px;
  margin: 0;
}

/* ---------- LEVEL INTRO ANIMATIONS ---------- */
.level-intro {
  position: fixed;
  inset: 0;
  background: var(--bg);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 300;
  animation: fadeIn 0.3s ease-out;
  gap: 30px;
  padding: 40px;
  overflow: hidden;
  overscroll-behavior: contain;
}

.level-intro.fade-out {
  animation: fadeOut 0.3s ease-out forwards;
}

.back-home {
  position: fixed;
  top: 15px;
  left: 15px;
  z-index: 1000;
  background: rgba(255, 255, 255, 0.9);
  color: #667eea;
  padding: 8px 16px;
  border-radius: 20px;
  text-decoration: none;
  font-size: 0.85rem;
  font-weight: 600;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  transition: all 0.2s;
}

.back-home:hover {
  background: white;
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
}

.intro-back-btn {
  font-size: 16px;
  font-weight: 600;
  color: var(--text-light);
  cursor: pointer;
  padding: 12px 20px;
  border-radius: 8px;
  background: transparent;
  transition: background 0.2s;
  text-align: center;
  margin-top: 10px;
}

.intro-back-btn:active {
  background: rgba(0, 0, 0, 0.05);
}

.intro-title {
  font-size: 42px;
  font-weight: 700;
  color: var(--dark);
  text-align: center;
  margin-bottom: 20px;
}

.intro-demo {
  width: 100%;
  max-width: 400px;
  height: 300px;
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
}

.demo-object {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  box-shadow: 0 10px 30px rgba(0,0,0,.15);
  position: absolute;
}

.demo-object.small {
  width: 50px;
  height: 50px;
}

.demo-object.blue {
  background: var(--blue);
}

.demo-object.pink {
  background: var(--pink);
}

/* Level 1: Sort demo - CLEAN VISUAL VERSION */
.sort-demo-visual {
  width: 100%;
  max-width: 400px;
  position: relative;
  display: flex;
  flex-direction: column;
  gap: 5px;
}

.demo-fall-area {
  height: 195px;
  position: relative;
}

.falling-ball {
  position: absolute;
  width: 70px;
  height: 70px;
  border-radius: 50%;
  left: 50%;
  transform: translateX(-50%);
  box-shadow: 0 8px 25px rgba(0,0,0,.2);
  top: 0;
}

.blue-demo {
  background: var(--blue);
  animation: fallAndDisappear 3s ease-in infinite;
}

.pink-demo {
  background: var(--pink);
  animation: fallAndDisappear 3s ease-in infinite;
  animation-delay: 1.5s;
  opacity: 0; /* Start invisible, animation will show it */
}

@keyframes fallAndDisappear {
  0% {
    top: 0;
    opacity: 1;
  }
  45% {
    top: 125px;
    opacity: 1;
  }
  50% {
    top: 125px;
    opacity: 0;
  }
  100% {
    top: 125px;
    opacity: 0;
  }
}

.demo-zones {
  height: 100px;
  max-height: 100px;
  min-height: 100px;
  display: flex;
  gap: 0;
  width: 100%;
  flex-shrink: 0;
}

.demo-zone {
  flex: 1;
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
}

.demo-left {
  background: var(--blue);
}

.demo-right {
  background: var(--pink);
}

.zone-burst {
  position: absolute;
  width: 120px;
  height: 120px;
  border-radius: 50%;
  opacity: 0;
}

.burst-blue {
  background: radial-gradient(circle, rgba(255, 255, 255, 1) 0%, rgba(255, 255, 255, 0.6) 30%, transparent 70%);
  box-shadow: 0 0 40px rgba(255, 255, 255, 0.8);
  animation: burstEffect 3s ease-out infinite;
}

.burst-pink {
  background: radial-gradient(circle, rgba(255, 255, 255, 1) 0%, rgba(255, 255, 255, 0.6) 30%, transparent 70%);
  box-shadow: 0 0 40px rgba(255, 255, 255, 0.8);
  animation: burstEffect 3s ease-out infinite;
  animation-delay: 1.5s;
}

@keyframes burstEffect {
  0%, 40% {
    transform: scale(0);
    opacity: 0;
  }
  50% {
    transform: scale(0.8);
    opacity: 1;
  }
  55% {
    transform: scale(1.2);
    opacity: 0.9;
  }
  65% {
    transform: scale(1.8);
    opacity: 0.4;
  }
  75%, 100% {
    transform: scale(2.5);
    opacity: 0;
  }
}

/* Remove old Level 1 styles that are no longer needed */

/* Level 2: Swap demo - COLORED BARS VERSION */
.swap-demo-bars {
  display: flex;
  flex-direction: column;
  gap: 20px;
  align-items: center;
  width: 100%;
  max-width: 400px;
}

.swap-demo-bars .score-display {
  font-size: 36px;
  font-weight: 700;
  color: var(--purple);
}

.swap-instruction {
  font-size: 20px;
  font-weight: 700;
  color: var(--dark);
  margin-bottom: 20px;
}

.bar-container {
  display: flex;
  gap: 20px;
  width: 100%;
  max-width: 320px;
  height: 100px;
  position: relative;
}

.swap-bar {
  flex: 1;
  border-radius: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 15px rgba(0,0,0,0.15);
  position: relative;
  animation: swapBars 3s ease-in-out infinite;
}

.blue-bar {
  background: var(--blue);
}

.pink-bar {
  background: var(--pink);
  animation-delay: 0s;
}

.swap-bar .arrow {
  font-size: 42px;
  font-weight: 700;
  color: white;
  text-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

@keyframes swapBars {
  0%, 40% {
    transform: translateX(0);
  }
  50%, 90% {
    transform: translateX(170px);
  }
  100% {
    transform: translateX(170px);
  }
}

.pink-bar {
  animation: swapBarsReverse 3s ease-in-out infinite;
}

@keyframes swapBarsReverse {
  0%, 40% {
    transform: translateX(0);
  }
  50%, 90% {
    transform: translateX(-170px);
  }
  100% {
    transform: translateX(-170px);
  }
}

/* OLD Level 2: Swap demo - keeping for reference */
.swap-demo .arrow-container {
  display: flex;
  gap: 120px;
  position: absolute;
  bottom: 60px;
}

.swap-demo .demo-arrow {
  font-size: 56px;
  animation: swapArrows 3s ease-in-out infinite;
}

.swap-demo .demo-arrow:first-child {
  animation-delay: 1.5s;
}

@keyframes swapArrows {
  0%, 40% {
    transform: translateX(0);
  }
  60%, 100% {
    transform: translateX(120px);
  }
}

.swap-demo .demo-arrow:last-child {
  animation: swapArrowsReverse 3s ease-in-out infinite;
  animation-delay: 1.5s;
}

@keyframes swapArrowsReverse {
  0%, 40% {
    transform: translateX(0);
  }
  60%, 100% {
    transform: translateX(-120px);
  }
}

.swap-demo .score-display {
  position: absolute;
  top: 40px;
  font-size: 48px;
  font-weight: 700;
  color: var(--purple);
  animation: scoreCount 3s ease-in-out infinite;
}

@keyframes scoreCount {
  0%, 40% {
    content: "0";
  }
  50% {
    transform: scale(1.3);
  }
  60%, 100% {
    content: "5";
    color: #FF6B6B;
  }
}

/* Level 3: Fake Out demo */
.fakeout-demo .demo-object {
  top: 20px;
  left: 50%;
  transform: translateX(-50%);
  animation: colorChange 3s ease-in infinite;
}

@keyframes colorChange {
  0%, 30% {
    background: var(--blue);
    top: 20px;
  }
  50% {
    background: var(--pink);
    top: 120px;
    transform: translateX(-50%) scale(1.1);
  }
  70%, 100% {
    background: var(--pink);
    top: 200px;
    opacity: 0;
  }
}

/* Level 4: Precision demo */
.precision-demo .demo-object {
  animation: shrinkDemo 3s ease-in-out infinite;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
}

@keyframes shrinkDemo {
  0%, 30% {
    width: 80px;
    height: 80px;
  }
  50%, 100% {
    width: 50px;
    height: 50px;
  }
}

.precision-demo .zone-demo {
  position: absolute;
  bottom: 0;
  width: 100%;
  height: 100px;
  display: flex;
  animation: narrowZones 3s ease-in-out infinite;
  gap: 0;
}

.zone-demo-left, .zone-demo-right {
  height: 100%;
  opacity: 0.3;
  transition: all 1s;
}

.zone-demo-left {
  background: linear-gradient(to top, var(--blue), transparent);
}

.zone-demo-right {
  background: linear-gradient(to top, var(--pink), transparent);
}

@keyframes narrowZones {
  0%, 30% {
    gap: 0;
  }
  50%, 100% {
    gap: 30%;
  }
}

/* Level 5: Mastery demo */
.mastery-demo {
  display: flex;
  flex-direction: column;
  gap: 30px;
  align-items: center;
}

.mastery-icons {
  display: flex;
  gap: 20px;
  flex-wrap: wrap;
  justify-content: center;
}

.mastery-icon {
  width: 80px;
  height: 80px;
  background: white;
  border-radius: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 36px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.1);
  animation: iconPulse 2s ease-in-out infinite;
}

.mastery-icon:nth-child(1) { animation-delay: 0s; }
.mastery-icon:nth-child(2) { animation-delay: 0.3s; }
.mastery-icon:nth-child(3) { animation-delay: 0.6s; }

@keyframes iconPulse {
  0%, 100% {
    transform: scale(1);
  }
  50% {
    transform: scale(1.1);
  }
}

/* Challenge intro styling */
.challenge-intro-content {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 20px;
}

.challenge-intro-desc {
  font-size: 20px;
  font-weight: 500;
  color: var(--dark);
  text-align: center;
  max-width: 300px;
  line-height: 1.4;
}

.challenge-intro-stats {
  display: flex;
  flex-direction: column;
  gap: 12px;
  align-items: center;
}

.challenge-stat {
  font-size: 18px;
  font-weight: 600;
  color: var(--text-light);
  padding: 8px 16px;
  background: rgba(255, 215, 0, 0.1);
  border-radius: 12px;
}

.intro-text {
  font-size: 24px;
  font-weight: 600;
  color: var(--dark);
  text-align: center;
  line-height: 1.4;
  max-width: 320px;
}

.intro-subtext {
  font-size: 16px;
  color: var(--text-light);
  text-align: center;
  margin-top: -15px;
}

.start-prompt {
  font-size: 20px;
  font-weight: 700;
  color: var(--purple);
  padding: 16px 40px;
  background: white;
  border-radius: 30px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.1);
  cursor: pointer;
  animation: bounce 2s ease-in-out infinite;
  margin-top: 20px;
}

@keyframes bounce {
  0%, 100% {
    transform: translateY(0);
  }
  50% {
    transform: translateY(-10px);
  }
}

.skip-intro {
  position: absolute;
  top: 20px;
  right: 20px;
  font-size: 14px;
  color: var(--text-light);
  background: rgba(255,255,255,0.8);
  padding: 8px 16px;
  border-radius: 20px;
  cursor: pointer;
  opacity: 0;
  animation: fadeIn 0.3s ease-out 1s forwards;
}

.skip-intro:active {
  transform: scale(0.95);
}

/* Unlock burst animation */
.unlock-burst {
  animation: unlockBurst 0.6s ease-out forwards;
}

@keyframes unlockBurst {
  0% {
    transform: translateX(-50%) scale(1);
  }
  50% {
    transform: translateX(-50%) scale(1.4);
    filter: brightness(1.5);
  }
  100% {
    transform: translateX(-50%) scale(1);
    filter: brightness(1);
  }
}

.unlock-particle {
  position: absolute;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  pointer-events: none;
  animation: unlockParticleExplode 0.8s ease-out forwards;
}

@keyframes unlockParticleExplode {
  0% {
    transform: translate(0, 0) scale(1);
    opacity: 1;
  }
  100% {
    transform: translate(var(--px), var(--py)) scale(0);
    opacity: 0;
  }
}
</style>
</head>

<body>
<a href="/" class="back-home" id="homeButton">‚Üê Home</a>

<!-- TITLE SCREEN -->
<div id="titleScreen" class="screen">
  <h1>Sort Panic</h1>
  <p class="tagline">Don't Think. Just Sort.</p>
  <button onclick="showLevelSelect()">START</button>
</div>

<!-- LEVEL SELECT -->
<div id="levelSelect" class="screen hidden"></div>

<!-- GAME -->
<div id="game" class="hidden">
  <div id="scoreDisplay">0</div>
  <div id="area"></div>
  <div id="controls">
    <div id="left" class="zone"><span>‚Üê</span></div>
    <div id="right" class="zone"><span>‚Üí</span></div>
  </div>
</div>

<!-- LEVEL COMPLETE + UNLOCK -->
<div id="levelComplete" class="screen hidden">
  <div class="celebration-screen">
    <h2>üéâ LEVEL COMPLETE üéâ</h2>
    <div class="complete-card">
      <div class="score-section">
        <div class="score-value" id="completeScore">0</div>
        <div class="target-met" id="targetMet">Target: 60 ‚úÖ</div>
      </div>
      <div class="unlock-section">
        <div class="unlock-text">LEVEL UNLOCKED!</div>
        <div class="unlock-level-name" id="unlockedLevelName">Level 2: Swap</div>
        <div class="unlock-level-desc" id="unlockedLevelDesc">Controls betray you</div>
      </div>
    </div>
    <button class="primary large" id="playNextBtn" onclick="playNextLevel()">‚ñ∂ PLAY LEVEL 2</button>
    <div class="button-row">
      <button class="compact" id="shareBtnComplete" onclick="shareScore()">üì§ Share</button>
      <button class="compact secondary" onclick="retry()">‚Ü∫ Retry</button>
      <button class="compact secondary" onclick="showLevelSelect()">‚Üê Back</button>
    </div>
  </div>
</div>

<!-- HIGH SCORE -->
<div id="highScore" class="screen hidden">
  <div class="highscore-screen">
    <h2>üèÜ NEW HIGH SCORE üèÜ</h2>
    <div class="highscore-card">
      <div class="score-display">
        <div class="new-score-value" id="newHighScore">0</div>
        <div class="score-improvement">
          <span class="previous-label">Previous:</span>
          <span id="previousScore">0</span>
        </div>
      </div>
      <div class="stats-line" id="highScoreStats"></div>
    </div>
    <button class="primary large" onclick="retry()">‚Ü∫ Play Again</button>
    <div class="button-row">
      <button class="compact" id="shareBtnHigh" onclick="shareScore()">üì§ Share</button>
      <button class="compact secondary" onclick="showLevelSelect()">‚Üê Back</button>
    </div>
  </div>
</div>

<!-- GAME OVER -->
<div id="gameOver" class="screen hidden">
  <h2>Game Over</h2>
  <div class="final-score" id="finalScore">0</div>
  <div class="stats" id="stats"></div>
  <div id="progressNotice"></div>
  <button id="shareBtn" onclick="shareScore()">üì§ Share Score</button>
  <button class="primary" onclick="retry()">‚Ü∫ Try Again</button>
  <button class="secondary" onclick="showLevelSelect()">‚Üê Level Select</button>
</div>

<!-- Install Prompt -->
<div id="installPrompt">
  <span>üì± Install Sort Panic for quick access!</span>
  <button onclick="installApp()">Install</button>
  <button class="secondary" onclick="dismissInstall()">Not Now</button>
</div>

<script>
/* ---------- AUDIO ---------- */
let audioCtx;

function playBeep(freq, dur, vol=0.2) {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.frequency.value = freq;
  g.gain.value = vol;
  o.connect(g);
  g.connect(audioCtx.destination);
  o.start();
  o.stop(audioCtx.currentTime + dur);
}

function playCorrectSound() {
  if (!audioCtx) return;
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();

  // Always same pleasant tone - no variation with speed
  osc.frequency.setValueAtTime(800, audioCtx.currentTime);
  osc.frequency.exponentialRampToValueAtTime(1000, audioCtx.currentTime + 0.08);

  gain.gain.setValueAtTime(0.18, audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.08);

  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.start();
  osc.stop(audioCtx.currentTime + 0.08);
}

function playSwapSound() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.frequency.setValueAtTime(600, audioCtx.currentTime);
  o.frequency.exponentialRampToValueAtTime(300, audioCtx.currentTime + 0.25);
  g.gain.setValueAtTime(0.15, audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.25);
  o.connect(g);
  g.connect(audioCtx.destination);
  o.start();
  o.stop(audioCtx.currentTime + 0.25);
}

function playComboSound(multiplier) {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  const freq = 600 + (multiplier * 100);
  playBeep(freq, 0.08, 0.15);
}

/* ---------- LEVEL INTRO ANIMATIONS ---------- */
let seenIntros = JSON.parse(localStorage.getItem('seenIntros') || '{}');

function showLevelIntro(levelId, callback) {
  // Check if already seen (skip after first time)
  if (seenIntros[levelId]) {
    callback();
    return;
  }
  
  const intro = document.createElement('div');
  intro.className = 'level-intro';
  
  let content = '';
  
  switch(levelId) {
    case 1:
      content = `
        <div class="intro-title">LEVEL 1: Sort</div>
        <div class="intro-demo sort-demo-visual">
          <div class="demo-fall-area">
            <div class="falling-ball blue-demo"></div>
            <div class="falling-ball pink-demo"></div>
          </div>
          <div class="demo-zones">
            <div class="demo-zone demo-left">
              <div class="zone-burst burst-blue"></div>
            </div>
            <div class="demo-zone demo-right">
              <div class="zone-burst burst-pink"></div>
            </div>
          </div>
        </div>
        <div class="intro-text">Match the colors!</div>
      `;
      break;
      
    case 2:
      content = `
        <div class="intro-title">LEVEL 2: Swap</div>
        <div class="intro-demo swap-demo-bars">
          <div class="swap-instruction">Controls will swap!</div>
          <div class="bar-container">
            <div class="swap-bar blue-bar">
              <span class="arrow">‚Üê</span>
            </div>
            <div class="swap-bar pink-bar">
              <span class="arrow">‚Üí</span>
            </div>
          </div>
        </div>
        <div class="intro-text">Stay alert...</div>
      `;
      break;
      
    case 3:
      content = `
        <div class="intro-title">LEVEL 3: Fake Out</div>
        <div class="intro-demo fakeout-demo">
          <div class="demo-object blue"></div>
        </div>
        <div class="intro-text">Colors can CHANGE mid-air!</div>
        <div class="intro-subtext">Watch carefully...</div>
      `;
      break;
      
    case 4:
      content = `
        <div class="intro-title">LEVEL 4: Precision</div>
        <div class="intro-demo precision-demo">
          <div class="demo-object blue"></div>
          <div class="zone-demo">
            <div class="zone-demo-left" style="flex: 1;"></div>
            <div class="zone-demo-right" style="flex: 1;"></div>
          </div>
        </div>
        <div class="intro-text">Smaller. Faster. Narrower.</div>
        <div class="intro-subtext">Precision required</div>
      `;
      break;
      
    case 5:
      content = `
        <div class="intro-title">LEVEL 5: Mastery</div>
        <div class="intro-demo mastery-demo">
          <div class="mastery-icons">
            <div class="mastery-icon">üîÑ</div>
            <div class="mastery-icon">üé®</div>
            <div class="mastery-icon">üéØ</div>
          </div>
        </div>
        <div class="intro-text">Swap + Fake Out + Precision</div>
        <div class="intro-subtext">Everything at once. Good luck.</div>
      `;
      break;
  }
  
  content += `
    <div class="start-prompt" onclick="startIntro()">TAP TO START</div>
    <div class="intro-back-btn" onclick="closeIntro()">‚Üê Back to Levels</div>
  `;
  
  intro.innerHTML = content;
  document.body.appendChild(intro);
  
  // Prevent body scroll
  document.body.style.overflow = 'hidden';
  
  // Hide Home button when intro is showing
  const homeBtn = document.getElementById('homeButton');
  if (homeBtn) homeBtn.style.display = 'none';
  
  // Store callback and intro element globally for click handlers
  window.introCallback = callback;
  window.currentIntro = intro;
  window.currentLevelIntro = levelId;
}

function startIntro() {
  if (!window.currentIntro) return;
  
  // Mark as seen
  seenIntros[window.currentLevelIntro] = true;
  localStorage.setItem('seenIntros', JSON.stringify(seenIntros));
  
  // Restore body scroll
  document.body.style.overflow = '';
  
  // Show Home button again
  const homeBtn = document.getElementById('homeButton');
  if (homeBtn) homeBtn.style.display = 'block';
  
  // Fade out intro
  window.currentIntro.classList.add('fade-out');
  
  setTimeout(() => {
    if (window.currentIntro) {
      window.currentIntro.remove();
      window.currentIntro = null;
    }
    if (window.introCallback) {
      window.introCallback();
      window.introCallback = null;
    }
  }, 300);
}

function skipIntro() {
  startIntro(); // Same behavior, just different trigger
}

function closeIntro() {
  const intro = document.querySelector('.level-intro');
  if (intro) {
    intro.classList.add('fade-out');
    setTimeout(() => intro.remove(), 300);
  }
  // Restore body scroll
  document.body.style.overflow = '';
  // Show Home button again
  const homeBtn = document.getElementById('homeButton');
  if (homeBtn) homeBtn.style.display = 'block';
  // Return to level select
  document.getElementById("levelSelect").classList.remove("hidden");
}

/* ---------- STATE ---------- */
const levels = [
  { id: 1, name: "Sort", description: "Learn the basics", unlock: 60 },
  { id: 2, name: "Swap", description: "Controls betray you", unlock: 40 },
  { id: 3, name: "Fake Out", description: "Colors change mid-fall", unlock: 50 },
  { id: 4, name: "Precision", description: "Smaller targets", unlock: 70 },
  { id: 5, name: "Mastery", description: "Everything at once", unlock: null }
];

let unlocked = JSON.parse(localStorage.getItem("unlocked") || '{"1":true}');
let bestScores = JSON.parse(localStorage.getItem("bestScores") || '{}');
let monthlyChallenge = null; // Will be loaded from server
let currentLevel = 1;
let score = 0;
let combo = 0;
let maxCombo = 0;
let perfect = true;
let active = false;
let current, y, speed, lastFrame, startTime;
let swapped = false;
let swapping = false; // Flag to block taps during swap animation
let swapScore = 0; // Random score when swap will happen
let colorChangeTimeout = null;

/* ---------- PWA / INSTALL ---------- */
let deferredPrompt;

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  
  // Show install prompt after 5 seconds if not installed
  setTimeout(() => {
    if (!window.matchMedia('(display-mode: standalone)').matches) {
      document.getElementById('installPrompt').classList.add('show');
    }
  }, 5000);
});

function installApp() {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then((choiceResult) => {
      deferredPrompt = null;
      document.getElementById('installPrompt').classList.remove('show');
    });
  }
}

function dismissInstall() {
  document.getElementById('installPrompt').classList.remove('show');
}

/* ---------- MONTHLY CHALLENGE ---------- */
async function loadMonthlyChallenge() {
  const CHALLENGE_URL = 'https://sortpanic.com/monthly-challenge.json';
  
  try {
    const response = await fetch(CHALLENGE_URL);
    const challenge = await response.json();
    
    // Cache it locally
    localStorage.setItem('monthly-challenge', JSON.stringify(challenge));
    localStorage.setItem('challenge-last-updated', Date.now());
    
    monthlyChallenge = challenge;
  } catch (error) {
    // Use cached version if offline
    const cached = localStorage.getItem('monthly-challenge');
    if (cached) {
      monthlyChallenge = JSON.parse(cached);
    }
  }
}

function getDaysRemaining(monthString) {
  // monthString format: "2026-02"
  const [year, month] = monthString.split('-').map(Number);
  const lastDay = new Date(year, month, 0); // Last day of the month
  const today = new Date();
  const diffTime = lastDay - today;
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  return Math.max(0, diffDays);
}

/* ---------- LEVEL SELECT ---------- */
function showLevelSelect() {
  active = false;
  document.getElementById("titleScreen").classList.add("hidden");
  document.getElementById("game").classList.add("hidden");
  document.getElementById("gameOver").classList.add("hidden");
  document.getElementById("levelComplete").classList.add("hidden");
  document.getElementById("highScore").classList.add("hidden");

  const ls = document.getElementById("levelSelect");
  ls.innerHTML = "";
  ls.classList.remove("hidden");

  // Add regular levels first
  levels.forEach(l => {
    const tile = document.createElement("div");
    const isUnlocked = unlocked[l.id];
    tile.className = "level-tile" + (isUnlocked ? "" : " locked");
    
    let content = `<div>LEVEL ${l.id}: ${l.name}<br><span>${l.description}</span>`;
    
    if (isUnlocked) {
      // Show best score if exists
      if (bestScores[l.id]) {
        content += `<div class="best-score">Best: ${bestScores[l.id]}</div>`;
      }
      
      // Show unlock requirement for next level (if not final level)
      if (l.unlock && l.id < levels.length) {
        const nextLevel = l.id + 1;
        const nextLevelUnlocked = unlocked[nextLevel];
        if (!nextLevelUnlocked) {
          content += `<div class="unlock-hint">üîì Score ${l.unlock} to unlock L${nextLevel}</div>`;
        }
      }
    } else {
      // Locked level - show unlock requirement
      const prevLevel = levels[l.id - 2]; // levels array is 0-indexed
      if (prevLevel && prevLevel.unlock) {
        content += `<div class="unlock-requirement">Unlock at ${prevLevel.unlock} points</div>`;
      }
    }
    
    content += `</div><div>${isUnlocked ? "‚ñ∂" : "üîí"}</div>`;
    
    tile.innerHTML = content;
    if (isUnlocked) tile.onclick = () => startLevel(l.id);
    ls.appendChild(tile);
  });
  
  // Add monthly challenge tile at the bottom
  if (monthlyChallenge) {
    const challengeTile = document.createElement("div");
    challengeTile.className = "level-tile challenge-tile";
    challengeTile.style.marginTop = "20px"; // Extra space above challenge
    const daysLeft = getDaysRemaining(monthlyChallenge.month);
    
    let content = `<div>üèÜ ${monthlyChallenge.challenge_name.toUpperCase()}<br><span>${monthlyChallenge.description}</span>`;
    content += `<div class="challenge-timer">‚è∞ ${daysLeft} days left</div>`;
    content += `<div class="challenge-target">üéØ Target: ${monthlyChallenge.target_score}</div>`;
    content += `</div><div>‚ñ∂</div>`;
    
    challengeTile.innerHTML = content;
    challengeTile.onclick = () => startChallenge();
    ls.appendChild(challengeTile);
  }
  
  // Add reset intros button at very bottom
  const resetBtn = document.createElement("button");
  resetBtn.className = "secondary";
  resetBtn.textContent = "üîÑ Watch Intros Again";
  resetBtn.style.marginTop = "20px";
  resetBtn.onclick = resetIntros;
  ls.appendChild(resetBtn);
}

function resetIntros() {
  seenIntros = {};
  localStorage.setItem('seenIntros', JSON.stringify(seenIntros));
  alert("Intro animations reset! You'll see them again when you play.");
}

/* ---------- CHALLENGE MODE ---------- */
function startChallenge() {
  if (!monthlyChallenge) return;
  
  // Show intro screen for monthly challenge
  showChallengeIntro();
}

function showChallengeIntro() {
  const intro = document.createElement('div');
  intro.className = 'level-intro';
  
  const daysLeft = getDaysRemaining(monthlyChallenge.month);
  
  const content = `
    <div class="intro-title">üèÜ ${monthlyChallenge.challenge_name}</div>
    <div class="intro-demo challenge-intro-content">
      <div class="challenge-intro-desc">${monthlyChallenge.description}</div>
      <div class="challenge-intro-stats">
        <div class="challenge-stat">‚è∞ ${daysLeft} days left</div>
        <div class="challenge-stat">üéØ Target: ${monthlyChallenge.target_score}</div>
      </div>
    </div>
    <div class="intro-text">Special monthly challenge</div>
    <div class="start-prompt" onclick="startChallengeGame()">TAP TO START</div>
    <div class="intro-back-btn" onclick="closeChallengeIntro()">‚Üê Back to Levels</div>
  `;
  
  intro.innerHTML = content;
  document.body.appendChild(intro);
  
  // Prevent body scroll
  document.body.style.overflow = 'hidden';
  
  // Hide Home button when intro is showing
  const homeBtn = document.getElementById('homeButton');
  if (homeBtn) homeBtn.style.display = 'none';
  
  document.getElementById("levelSelect").classList.add("hidden");
}

function closeChallengeIntro() {
  const intro = document.querySelector('.level-intro');
  if (intro) {
    intro.classList.add('fade-out');
    setTimeout(() => intro.remove(), 300);
  }
  // Restore body scroll
  document.body.style.overflow = '';
  // Show Home button again
  const homeBtn = document.getElementById('homeButton');
  if (homeBtn) homeBtn.style.display = 'block';
  // Return to level select
  document.getElementById("levelSelect").classList.remove("hidden");
}

function startChallengeGame() {
  // Remove intro
  const intro = document.querySelector('.level-intro');
  if (intro) {
    intro.classList.add('fade-out');
    setTimeout(() => intro.remove(), 300);
  }
  
  // Set up challenge mode
  currentLevel = 'challenge';
  score = 0;
  combo = 0;
  maxCombo = 0;
  perfect = true;
  swapped = false;
  swapping = false;
  active = true;
  startTime = performance.now();
  lastFrame = performance.now();

  document.getElementById("titleScreen").classList.add("hidden");
  document.getElementById("levelSelect").classList.add("hidden");
  document.getElementById("gameOver").classList.add("hidden");
  document.getElementById("game").classList.remove("hidden");
  document.getElementById("scoreDisplay").textContent = "0";
  document.getElementById("area").innerHTML = "";

  // Apply challenge rules from JSON
  const leftZone = document.getElementById("left");
  const rightZone = document.getElementById("right");
  leftZone.classList.remove("swapped-zone", "narrow");
  rightZone.classList.remove("swapped-zone", "narrow");

  // Apply narrow zones if specified
  if (monthlyChallenge.narrow_zones) {
    leftZone.classList.add("narrow");
    rightZone.classList.add("narrow");
  }
  
  // Set up swap controls if specified (like Level 2)
  if (monthlyChallenge.swap_controls) {
    // Set a random score when swap will happen
    swapScore = Math.floor(Math.random() * 11) + 5; // Random between 5-15
  }
  
  // Apply theme color if specified
  if (monthlyChallenge.theme_color) {
    document.getElementById("game").style.background = monthlyChallenge.theme_color;
  }

  spawn();
  requestAnimationFrame(loop);
}

/* ---------- PARTICLE EFFECTS ---------- */
function createParticles(x, y, color) {
  for (let i = 0; i < 8; i++) {
    const particle = document.createElement('div');
    particle.className = 'particle';
    particle.style.background = color;
    particle.style.left = x + 'px';
    particle.style.top = y + 'px';
    
    const angle = (Math.PI * 2 * i) / 8;
    const distance = 30 + Math.random() * 30;
    particle.style.setProperty('--tx', Math.cos(angle) * distance + 'px');
    particle.style.setProperty('--ty', Math.sin(angle) * distance + 'px');
    
    document.getElementById('area').appendChild(particle);
    setTimeout(() => particle.remove(), 600);
  }
}

/* ---------- GAME ---------- */
function startLevel(lvl) {
  // Show intro animation first
  showLevelIntro(lvl, () => {
    // This callback runs after intro is dismissed
    beginLevel(lvl);
  });
}

function beginLevel(lvl) {
  currentLevel = lvl;
  score = 0;
  combo = 0;
  maxCombo = 0;
  perfect = true;
  swapped = false;
  swapping = false;
  active = true;
  startTime = performance.now();
  lastFrame = performance.now();

  // Set random swap score for Level 2 & 5 (between 5-15)
  if (lvl === 2 || lvl === 5) {
    swapScore = Math.floor(Math.random() * 11) + 5; // Random between 5-15
    console.log(`Level ${lvl}: Swap will happen at score ${swapScore}`);
  }

  // Hide all screens
  document.getElementById("titleScreen").classList.add("hidden");
  document.getElementById("levelSelect").classList.add("hidden");
  document.getElementById("gameOver").classList.add("hidden");
  document.getElementById("levelComplete").classList.add("hidden");
  document.getElementById("highScore").classList.add("hidden");
  
  // Show game
  document.getElementById("game").classList.remove("hidden");
  document.getElementById("scoreDisplay").textContent = "0";
  document.getElementById("area").innerHTML = "";

  // Level 4: Precision - narrow control zones
  const leftZone = document.getElementById("left");
  const rightZone = document.getElementById("right");
  
  // Clear any previous swap state
  leftZone.classList.remove("swapped-zone");
  rightZone.classList.remove("swapped-zone");
  
  if (lvl === 4 || lvl === 5) {
    leftZone.classList.add("narrow");
    rightZone.classList.add("narrow");
  } else {
    leftZone.classList.remove("narrow");
    rightZone.classList.remove("narrow");
  }

  spawn();
  requestAnimationFrame(loop);
}

function spawn(isGraceBall = false) {
  current = document.createElement("div");
  current.className = "object";
  
  // Ball size: use challenge setting or default 80px
  const ballSize = (currentLevel === 'challenge' && monthlyChallenge && monthlyChallenge.ball_size) 
    ? monthlyChallenge.ball_size 
    : 80;
  
  current.style.width = `${ballSize}px`;
  current.style.height = `${ballSize}px`;
  
  const color = Math.random() < .5 ? "blue" : "pink";
  current.dataset.color = color;
  current.dataset.originalColor = color;
  current.style.background = color === "blue" ? "var(--blue)" : "var(--pink)";
  y = 0;
  current.style.top = "0px";
  document.getElementById("area").appendChild(current);

  const elapsed = (performance.now() - startTime) / 1000;
  
  // Level-specific speed adjustments
  let baseSpeed = 180;
  let speedIncrease = 12;
  
  if (currentLevel === 3) {
    baseSpeed = 160; // Slower for Fake Out (color changes need reaction time)
    speedIncrease = 5; // Very gentle acceleration to keep it playable with color changes
  } else if (currentLevel === 4) {
    baseSpeed = 220; // Faster for precision
    speedIncrease = 15;
  } else if (currentLevel === 5) {
    baseSpeed = 200;
    speedIncrease = 18;
  } else if (currentLevel === 'challenge' && monthlyChallenge) {
    // Apply challenge speed multiplier
    baseSpeed = 180 * (monthlyChallenge.ball_speed_multiplier || 1);
    speedIncrease = 12 * (monthlyChallenge.ball_speed_multiplier || 1);
  }
  
  speed = Math.min(450, baseSpeed + elapsed * speedIncrease);
  
  // Grace ball: slower for first ball after certain events
  if (isGraceBall) {
    const graceMultiplier = (currentLevel === 'challenge' && monthlyChallenge && monthlyChallenge.grace_ball_multiplier) 
      ? monthlyChallenge.grace_ball_multiplier 
      : 0.8;
    speed = speed * graceMultiplier;
  }

  // Color change logic (Level 3, Level 5, or Challenge mode)
  const shouldColorChange = (currentLevel === 3 || currentLevel === 5) ||
    (currentLevel === 'challenge' && monthlyChallenge && monthlyChallenge.color_change_chance > 0);
  
  const colorChangeChance = (currentLevel === 'challenge' && monthlyChallenge && monthlyChallenge.color_change_chance)
    ? monthlyChallenge.color_change_chance
    : 0.4;
  
  if (shouldColorChange && Math.random() < colorChangeChance) {
    // Micro-pause duration: longer for Level 3, configurable for challenge mode
    const pauseDuration = (currentLevel === 'challenge' && monthlyChallenge && monthlyChallenge.color_change_pause_ms)
      ? monthlyChallenge.color_change_pause_ms
      : (currentLevel === 3 ? 110 : 85); // Longer pause for Level 3 to give reaction time
    
    // Change color early (random time between 200-800ms, ensuring it happens in top 40%)
    const timeToChange = Math.random() * 600 + 200; // 200-800ms
      
    colorChangeTimeout = setTimeout(() => {
      if (current && active) {
        // Double-check ball is still in top 40%
        const currentY = parseFloat(current.style.top);
        const screenHeight = window.innerHeight;
        
        if (currentY < screenHeight * 0.4) {
          // Micro-pause: freeze the ball
          const savedSpeed = speed;
          speed = 0; // Freeze movement
          
          // Change color
          const newColor = current.dataset.color === "blue" ? "pink" : "blue";
          current.dataset.color = newColor;
          current.style.background = newColor === "blue" ? "var(--blue)" : "var(--pink)";
          current.style.transition = "background 0.3s";
          
          // Resume after pause
          setTimeout(() => {
            if (current && active) {
              speed = savedSpeed; // Restore speed
            }
          }, pauseDuration);
        }
      }
    }, timeToChange);
  }
  
  // Restart the animation loop
  requestAnimationFrame(loop);
}

function loop(now) {
  if (!active || !current) return;
  const delta = (now - lastFrame) / 1000;
  lastFrame = now;

  y += speed * delta;
  current.style.top = y + "px";

  const areaHeight = document.getElementById("area").clientHeight;
  const objectHeight = 80; // All balls are now normal size

  if (y >= areaHeight - objectHeight) {
    endGame();
  } else {
    requestAnimationFrame(loop);
  }
}

function performSwap() {
  const left = document.getElementById("left");
  const right = document.getElementById("right");
  
  playSwapSound();

  // Swap the zones by adding a class that changes their gradient
  left.classList.add("swapped-zone");
  right.classList.add("swapped-zone");
}

function updateCombo() {
  combo++;
  if (combo > maxCombo) maxCombo = combo;
  // Combo tracked for stats only, not displayed during gameplay
}

function createUnlockBurst() {
  const scoreEl = document.getElementById("scoreDisplay");
  
  // Add burst animation to score
  scoreEl.classList.add("unlock-burst");
  setTimeout(() => scoreEl.classList.remove("unlock-burst"), 600);
  
  // Get score position for particles
  const rect = scoreEl.getBoundingClientRect();
  const centerX = rect.left + rect.width / 2;
  const centerY = rect.top + rect.height / 2;
  
  // Create particle burst
  for (let i = 0; i < 16; i++) {
    const particle = document.createElement('div');
    particle.className = 'unlock-particle';
    
    // Rainbow colors for unlock celebration
    const colors = ['#FFD700', '#FF69B4', '#B8D4FF', '#B8FFD9', '#E6CCFF'];
    particle.style.background = colors[i % colors.length];
    
    particle.style.left = centerX + 'px';
    particle.style.top = centerY + 'px';
    
    const angle = (Math.PI * 2 * i) / 16;
    const distance = 60 + Math.random() * 40;
    particle.style.setProperty('--px', Math.cos(angle) * distance + 'px');
    particle.style.setProperty('--py', Math.sin(angle) * distance + 'px');
    
    document.body.appendChild(particle);
    setTimeout(() => particle.remove(), 800);
  }
  
  // Play pleasant unlock sound (same as correct sort)
  playCorrectSound();
}

function resetCombo() {
  combo = 0;
  // No display to hide - combo tracked for stats only
}

function tap(side) {
  if (!active || !current) return;

  let effectiveSide = side;
  
  // Swap controls: Level 2, Level 5, or Challenge mode with swap_controls enabled
  const shouldSwap = ((currentLevel === 2 || currentLevel === 5) && swapped) ||
    (currentLevel === 'challenge' && monthlyChallenge && monthlyChallenge.swap_controls && swapped);
  
  if (shouldSwap) {
    effectiveSide = side === "left" ? "right" : "left";
  }

  const correct = current.dataset.color === "blue" ? "left" : "right";

  if (effectiveSide === correct) {
    // Correct!
    playCorrectSound();
    score++;
    document.getElementById("scoreDisplay").textContent = score;
    
    // Check if player just reached unlock threshold (only for regular levels)
    if (currentLevel !== 'challenge') {
      const currentLevelData = levels[currentLevel - 1];
      if (currentLevelData && currentLevelData.unlock && score === currentLevelData.unlock) {
        createUnlockBurst();
      }
    }
    
    // Particle effect
    const rect = current.getBoundingClientRect();
    const centerX = rect.left + rect.width / 2;
    const centerY = rect.top + rect.height / 2;
    createParticles(centerX, centerY, current.style.background);
    
    // Update combo
    updateCombo();
    
    // Swap trigger: Level 2, Level 5, or Challenge mode with swap_controls
    const shouldTriggerSwap = ((currentLevel === 2 || currentLevel === 5) && score === swapScore && !swapped) ||
      (currentLevel === 'challenge' && monthlyChallenge && monthlyChallenge.swap_controls && score === swapScore && !swapped);
    
    if (shouldTriggerSwap) {
      swapped = true;
      
      // Don't swap immediately during success moment
      // Instead: finish current ball normally, THEN swap before next spawn
      
      // Normal ball removal
      current.classList.add("explode");
      const objectToRemove = current;
      setTimeout(() => {
        if (objectToRemove.parentElement) {
          objectToRemove.parentElement.removeChild(objectToRemove);
        }
      }, 300);
      
      // Clear current so loop doesn't try to animate exploded ball
      current = null;
      
      if (colorChangeTimeout) {
        clearTimeout(colorChangeTimeout);
        colorChangeTimeout = null;
      }
      
      // Perform swap BETWEEN balls (after explosion, before spawn)
      setTimeout(() => {
        performSwap();
        
        // Spawn first post-swap ball slightly slower
        setTimeout(() => {
          spawn(true); // true = grace ball (slower)
        }, 450); // Wait for swap animation
      }, 350); // After current ball is gone
      
      return; // Don't continue normal flow
    }
    
    // Normal flow: Remove object with animation, then spawn
    current.classList.add("explode");
    const objectToRemove = current;
    setTimeout(() => {
      if (objectToRemove.parentElement) {
        objectToRemove.parentElement.removeChild(objectToRemove);
      }
    }, 300);
    
    if (colorChangeTimeout) {
      clearTimeout(colorChangeTimeout);
      colorChangeTimeout = null;
    }

    spawn();
  } else {
    // Wrong!
    perfect = false;
    resetCombo();
    endGame();
  }
}

function endGame() {
  active = false;
  playBeep(150, .3);
  
  // Screen shake
  document.getElementById("game").classList.add("shake");
  setTimeout(() => {
    document.getElementById("game").classList.remove("shake");
  }, 300);

  // Save previous best before updating
  const previousBest = bestScores[currentLevel] || 0;
  const isNewHighScore = score > previousBest;

  // Update best score
  if (!bestScores[currentLevel] || score > bestScores[currentLevel]) {
    bestScores[currentLevel] = score;
    localStorage.setItem("bestScores", JSON.stringify(bestScores));
  }

  // Check for unlock (only for regular levels, not challenge)
  let justUnlockedLevel = false;
  let nextLevelNum = 0;
  if (currentLevel !== 'challenge') {
    const currentLevelData = levels[currentLevel - 1];
    
    if (currentLevelData && currentLevelData.unlock && score >= currentLevelData.unlock) {
      nextLevelNum = currentLevel + 1;
      if (!unlocked[nextLevelNum] && nextLevelNum <= levels.length) {
        unlocked[nextLevelNum] = true;
        localStorage.setItem("unlocked", JSON.stringify(unlocked));
        justUnlockedLevel = true;
      }
    }
  }

  // Show perfect badge
  if (perfect && score >= 10) {
    const badge = document.createElement("div");
    badge.className = "perfect-badge";
    badge.textContent = "‚ú® PERFECT ‚ú®";
    document.getElementById("area").appendChild(badge);
    setTimeout(() => badge.remove(), 1500);
  }

  // Hide game screen
  document.getElementById("game").classList.add("hidden");
  
  // DECIDE WHICH SCREEN TO SHOW
  
  // SCREEN 1: Level Complete + Unlock
  if (justUnlockedLevel) {
    showLevelCompleteScreen(nextLevelNum);
  }
  // SCREEN 2: High Score (beat previous best, but no unlock)
  else if (isNewHighScore) {
    showHighScoreScreen(previousBest);
  }
  // SCREEN 3: Game Over (didn't beat previous best)
  else {
    showGameOverScreen();
  }
}

function showLevelCompleteScreen(nextLevel) {
  // Hide other screens
  document.getElementById("gameOver").classList.add("hidden");
  document.getElementById("highScore").classList.add("hidden");
  
  // Populate data
  document.getElementById("completeScore").textContent = score;
  
  const currentLevelData = levels[currentLevel - 1];
  document.getElementById("targetMet").textContent = `Target: ${currentLevelData.unlock} ‚úÖ`;
  
  const nextLevelData = levels[nextLevel - 1];
  document.getElementById("unlockedLevelName").textContent = `Level ${nextLevel}: ${nextLevelData.name}`;
  document.getElementById("unlockedLevelDesc").textContent = nextLevelData.description;
  
  // Update button text and handler
  document.getElementById("playNextBtn").textContent = `‚ñ∂ PLAY LEVEL ${nextLevel}`;
  // Show intro for newly unlocked level (first time playing it)
  document.getElementById("playNextBtn").onclick = () => startLevel(nextLevel);
  
  // Show screen
  document.getElementById("levelComplete").classList.remove("hidden");
}

function showHighScoreScreen(previousBest) {
  // Hide other screens
  document.getElementById("gameOver").classList.add("hidden");
  document.getElementById("levelComplete").classList.add("hidden");
  
  // Populate data
  document.getElementById("newHighScore").textContent = score;
  document.getElementById("previousScore").textContent = previousBest;
  
  // Stats - simple and clean
  let stats = "";
  if (perfect && score >= 10) {
    stats = "‚ú® Perfect Run!";
  } else {
    const improvement = score - previousBest;
    stats = `${improvement} points better!`;
  }
  
  document.getElementById("highScoreStats").textContent = stats;
  
  // Show screen
  document.getElementById("highScore").classList.remove("hidden");
}

function showGameOverScreen() {
  // Hide other screens
  document.getElementById("levelComplete").classList.add("hidden");
  document.getElementById("highScore").classList.add("hidden");
  
  // Populate data
  document.getElementById("finalScore").textContent = score;
  
  // Stats - just show perfect run if applicable
  let stats = "";
  if (perfect && score >= 10) {
    stats = "‚ú® Perfect Run!";
  }
  document.getElementById("stats").textContent = stats;
  
  // Progress notice (how close to unlocking next level)
  const progressNotice = document.getElementById("progressNotice");
  if (currentLevel !== 'challenge') {
    const currentLevelData = levels[currentLevel - 1];
    const nextLevel = currentLevel + 1;
    
    if (currentLevelData && currentLevelData.unlock && !unlocked[nextLevel] && nextLevel <= levels.length) {
      const needed = currentLevelData.unlock - score;
      if (needed > 0) {
        progressNotice.textContent = `Need ${needed} more points to unlock Level ${nextLevel}`;
      } else {
        progressNotice.textContent = "";
      }
    } else {
      progressNotice.textContent = "";
    }
  } else {
    progressNotice.textContent = "";
  }
  
  // Show screen
  document.getElementById("gameOver").classList.remove("hidden");
}

function playNextLevel() {
  // This function is set dynamically in showLevelCompleteScreen
  // But including a default handler just in case
  const nextLevel = currentLevel + 1;
  if (nextLevel <= levels.length) {
    startLevel(nextLevel);
  }
}

function retry() {
  // Skip intro animation when retrying - go straight to game
  beginLevel(currentLevel);
}

/* ---------- SHARE ---------- */
async function shareScore() {
  const text = `I panicked at ${score} üò≠ Can you beat me? sortpanic.com/play`;
  
  // Try Android bridge first (works reliably in APK)
  if (typeof AndroidBridge !== 'undefined' && AndroidBridge.share) {
    AndroidBridge.share(text);
    return;
  }
  
  // Try native Web Share API (works in browsers)
  if (navigator.share) {
    try {
      await navigator.share({ text: text });
      return;
    } catch (err) {
      // Fall through to clipboard
    }
  }
  
  // Fallback to clipboard
  copyToClipboard(text);
}

function copyToClipboard(text) {
  // Try modern Clipboard API first
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).then(() => {
      alert('Score copied to clipboard! üìã\nPaste it to share with friends!');
    }).catch(() => {
      // Fallback to old method
      fallbackCopy(text);
    });
  } else {
    fallbackCopy(text);
  }
}

function fallbackCopy(text) {
  const textarea = document.createElement('textarea');
  textarea.value = text;
  textarea.style.position = 'fixed';
  textarea.style.opacity = '0';
  document.body.appendChild(textarea);
  textarea.select();
  
  try {
    document.execCommand('copy');
    alert('Score copied to clipboard! üìã\nPaste it to share with friends!');
  } catch (err) {
    alert('Could not copy score. Your score: ' + text);
  }
  
  document.body.removeChild(textarea);
}

/* ---------- INPUT ---------- */
document.getElementById("left").onclick = () => tap("left");
document.getElementById("right").onclick = () => tap("right");

// Touch events for better mobile responsiveness
document.getElementById("left").addEventListener("touchstart", (e) => {
  e.preventDefault();
  tap("left");
});

document.getElementById("right").addEventListener("touchstart", (e) => {
  e.preventDefault();
  tap("right");
});

/* ---------- INIT ---------- */
// Load monthly challenge on startup
loadMonthlyChallenge();

// Auto-init audio on first interaction
document.addEventListener('click', () => {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
}, { once: true });
</script>
</body>
</html>
